<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bracket Voting ‚Äì Monad Testnet</title>
  <style>
    :root{color-scheme:dark}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#000;color:#e5e7eb;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji}
    a{color:#a5b4fc;text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:24px}
    .title{font-size:22px;font-weight:700;letter-spacing:.2px}
    .card{background:rgba(17,17,17,.9);border:1px solid #262626;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .toolbar{display:flex;align-items:center;gap:10px}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid #333;background:#111;color:#eee;cursor:pointer;transition:.15s}
    .btn:hover{background:#151515}
    .btn.primary{background:#4f46e5;border-color:#4f46e5}
    .btn.primary:hover{filter:brightness(1.1)}
    .badge{font-size:12px;padding:6px 10px;border:1px solid #2a2a2a;border-radius:999px;background:#0b0b0b;color:#cbd5e1}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:18px}
    .bracket{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;align-items:center}
    .col{display:flex;flex-direction:column;gap:16px}
    .match{padding:12px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-radius:12px;border:1px solid #2a2a2a;background:linear-gradient(180deg,#0b0b0b,#0a0a0a)}
    .row.win{border-color:#16a34a}
    .row.lose{opacity:.75}
    .pname{font-weight:700}
    .actions{display:flex;align-items:center;gap:8px}
    input.qty{width:64px;background:#0c0c0c;border:1px solid #2a2a2a;border-radius:10px;padding:8px;color:#fff}
    .timer{font-size:12px;color:#9ca3af}
    .panel{padding:16px}
    .subtitle{font-weight:700;margin:0 0 8px 0;font-size:14px;color:#a3a3a3}
    .footer{margin-top:28px;text-align:center;color:#9ca3af}
    .footer a{color:#9ca3af}
    .split{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .muted{color:#9ca3af}
    .pill{padding:6px 10px;border-radius:999px;background:#111;border:1px solid #2a2a2a}
    .hint{font-size:12px;color:#a3a3a3}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .logo{width:26px;height:26px;border-radius:50%;object-fit:cover;border:1px solid #2a2a2a;background:#111}
    /* connectors (simple) */
    .connector{height:2px;background:#1f2937;margin:4px 0;border-radius:1px}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .bracket{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="title">üèÜ Bracket Voting ‚Äî Monad Testnet</div>
        <div class="muted hint">8 peserta ‚Ä¢ Round 1 = 4 match (24 jam) ‚Ä¢ Biaya per vote: <b>0.1 MON</b> ‚Ä¢ ChainID <span class="mono">10143</span></div>
      </div>
      <div class="toolbar">
        <span id="networkBadge" class="badge">Not connected</span>
        <button id="connectBtn" class="btn">Connect Wallet</button>
      </div>
    </div>

    <div class="grid">
      <div class="card panel">
        <div class="split">
          <div class="subtitle">Bracket</div>
          <div class="hint">Contract: <span class="mono" id="addr"></span></div>
        </div>
        <div id="bracket" class="bracket"></div>
      </div>

      <div class="card panel">
        <div class="subtitle">Admin (owner only)</div>
        <div class="hint" style="margin-bottom:10px">Tombol ini hanya berhasil bila wallet yang terhubung adalah <i>owner</i> kontrak.</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" id="startBtn">Start Tournament</button>
          <button class="btn" id="forceBtn">Force Finish Expired</button>
        </div>
        <div style="height:8px"></div>
        <div class="subtitle">Finish Match (manual)</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="roundInput" class="qty" type="number" min="1" value="1"/>
          <input id="matchInput" class="qty" type="number" min="1" value="1"/>
          <button class="btn" id="finishBtn">Finish</button>
        </div>
        <div style="height:12px"></div>
        <div class="subtitle">Treasury</div>
        <div class="mono hint" id="treasury"></div>
      </div>
    </div>

    <div class="footer">
      created by <a href="https://x.com/ega_2ez4crypto" target="_blank" rel="noopener">https://x.com/ega_2ez4crypto</a>
    </div>
  </div>

  <!-- Ethers v6 via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js"></script>

  <script>
  // ====== CONFIG ======
  const RPC_URL = 'https://testnet-rpc.monad.xyz';
  const CHAIN_ID = 10143;
  const CONTRACT_ADDRESS = '0x31Cab363Ef737D83Ea72E04C811397049e06b619';
  const TREASURY = '0x6c2AA81b02a940c04A570aFFe7a413ca54C625cf';
  const VOTE_COST = 0.1; // MON per vote

  // Optional: logo URLs (you can change later)
  const PARTICIPANT_LOGOS = {
    1: '', // LUMITERRA
    2: '', // KURU EXCHANGE
    3: '', // KIZZY MOBILE
    4: '', // CRYSTAL
    5: '', // CULT
    6: '', // aPriori
    7: '', // Magma
    8: ''  // O.LAB
  };

  // Fallback names if on-chain names are empty
  const FALLBACK_NAMES = [
    null,
    'LUMITERRA','KURU EXCHANGE','KIZZY MOBILE','CRYSTAL',
    'CULT','aPriori','Magma','O.LAB'
  ];

  document.getElementById('addr').textContent = CONTRACT_ADDRESS;
  document.getElementById('treasury').textContent = TREASURY;

  // ====== ABI (from user) ======
  const ABI = [
	{"inputs":[{"internalType":"uint256","name":"roundNum","type":"uint256"},{"internalType":"uint256","name":"matchNum","type":"uint256"}],"name":"finishMatch","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"inputs":[],"name":"forceFinishExpiredMatches","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
	{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"round","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"matchIndex","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"winner","type":"uint256"}],"name":"MatchFinished","type":"event"},
	{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"round","type":"uint256"}],"name":"RoundFinished","type":"event"},
	{"inputs":[],"name":"startTournament","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"winner","type":"uint256"}],"name":"TournamentFinished","type":"event"},
	{"inputs":[{"internalType":"uint256","name":"roundNum","type":"uint256"},{"internalType":"uint256","name":"matchNum","type":"uint256"},{"internalType":"uint256","name":"participantId","type":"uint256"}],"name":"vote","outputs":[],"stateMutability":"payable","type":"function"},
	{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"voter","type":"address"},{"indexed":false,"internalType":"uint256","name":"round","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"matchIndex","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"participant","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"VoteCast","type":"event"},
	{"inputs":[],"name":"currentRound","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[],"name":"getCurrentMatches","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"uint256","name":"roundNum","type":"uint256"},{"internalType":"uint256","name":"matchNum","type":"uint256"}],"name":"getMatch","outputs":[{"internalType":"uint256","name":"participant1Id","type":"uint256"},{"internalType":"uint256","name":"participant2Id","type":"uint256"},{"internalType":"uint256","name":"votes1","type":"uint256"},{"internalType":"uint256","name":"votes2","type":"uint256"},{"internalType":"uint256","name":"winnerId","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"finished","type":"bool"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"uint256","name":"id","type":"uint256"}],"name":"getParticipant","outputs":[{"internalType":"string","name":"name","type":"string"},{"internalType":"bool","name":"active","type":"bool"},{"internalType":"uint256","name":"totalVotes","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[],"name":"getParticipantCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[],"name":"getRoundCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[],"name":"getTournamentState","outputs":[{"internalType":"uint8","name":"tournamentState","type":"uint8"},{"internalType":"uint256","name":"round","type":"uint256"},{"internalType":"uint256","name":"totalRounds","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"participants","outputs":[{"internalType":"string","name":"name","type":"string"},{"internalType":"bool","name":"active","type":"bool"},{"internalType":"uint256","name":"totalVotes","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[],"name":"ROUND_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"rounds","outputs":[{"internalType":"bool","name":"finished","type":"bool"}],"stateMutability":"view","type":"function"},
	{"inputs":[],"name":"state","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
	{"inputs":[],"name":"treasury","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userVotes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[],"name":"VOTE_COST","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
  ];

  // ====== Providers & Contract ======
  const { BrowserProvider, JsonRpcProvider, Contract, parseEther } = ethers;
  const readProvider = new JsonRpcProvider(RPC_URL, CHAIN_ID);
  const readContract = new Contract(CONTRACT_ADDRESS, ABI, readProvider);

  let browserProvider = null; // set after connect
  let writeContract = null;
  let currentAccount = null;

  async function ensureChain(){
    if(!window.ethereum) throw new Error('Wallet not found');
    const provider = new BrowserProvider(window.ethereum);
    const net = await provider.getNetwork();
    if(Number(net.chainId) !== CHAIN_ID){
      await provider.send('wallet_addEthereumChain', [{
        chainId: '0x'+CHAIN_ID.toString(16),
        chainName: 'Monad Testnet',
        nativeCurrency: { name: 'MON', symbol: 'MON', decimals: 18 },
        rpcUrls: [RPC_URL],
        blockExplorerUrls: []
      }]);
    }
  }

  async function connect(){
    await ensureChain();
    browserProvider = new BrowserProvider(window.ethereum);
    const accounts = await browserProvider.send('eth_requestAccounts', []);
    currentAccount = accounts[0];
    const signer = await browserProvider.getSigner();
    writeContract = new Contract(CONTRACT_ADDRESS, ABI, signer);
    document.getElementById('connectBtn').textContent = currentAccount.slice(0,6)+'‚Ä¶'+currentAccount.slice(-4);
    document.getElementById('networkBadge').textContent = 'Connected';
    document.getElementById('networkBadge').className = 'badge';
  }

  document.getElementById('connectBtn').addEventListener('click', async()=>{
    try{ await connect(); }catch(e){ alert(e.message||e) }
  });

  // ====== Reads ======
  async function getParticipantCount(){ return Number(await readContract.getParticipantCount()); }
  async function getParticipant(id){ const p = await readContract.getParticipant(id); return { id, name: p.name || (FALLBACK_NAMES[id]||('P'+id)), active: p.active, totalVotes: Number(p.totalVotes) }; }
  async function getMatch(roundNum, matchNum){
    const m = await readContract.getMatch(roundNum, matchNum);
    const [p1,p2,v1,v2,wid,st,et,fin] = m;
    return { round: Number(roundNum), match: Number(matchNum), p1: Number(p1), p2: Number(p2), v1: Number(v1), v2: Number(v2), winnerId: Number(wid), startTime: Number(st), endTime: Number(et), finished: Boolean(fin) };
  }
  async function getTournamentState(){
    const s = await readContract.getTournamentState();
    return { state: Number(s.tournamentState), round: Number(s.round), totalRounds: Number(s.totalRounds) };
  }

  // ====== Writes ======
  async function vote(roundNum, matchNum, participantId, qty){
    if(!writeContract) await connect();
    const total = (VOTE_COST * Number(qty)).toString();
    const tx = await writeContract.vote(roundNum, matchNum, participantId, { value: parseEther(total) });
    await tx.wait();
    toast('Vote submitted: '+tx.hash.slice(0,10)+'‚Ä¶');
    await refresh();
  }
  async function startTournament(){ if(!writeContract) await connect(); const tx = await writeContract.startTournament(); await tx.wait(); toast('Tournament started'); await refresh(); }
  async function finishMatch(roundNum, matchNum){ if(!writeContract) await connect(); const tx = await writeContract.finishMatch(roundNum, matchNum); await tx.wait(); toast('Match finished'); await refresh(); }
  async function forceFinish(){ if(!writeContract) await connect(); const tx = await writeContract.forceFinishExpiredMatches(); await tx.wait(); toast('Forced finish executed'); await refresh(); }

  // ====== UI Helpers ======
  function fmtTime(ms){
    if(ms<=0) return '00:00:00';
    const s = Math.floor(ms/1000); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const ss=s%60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  }
  function imgTag(id){
    const url = PARTICIPANT_LOGOS[id]||'';
    return `<img class="logo" src="${url||'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\"><rect width=\"100%\" height=\"100%\" fill=\"#111\"/><text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" fill=\"#6b7280\" font-size=\"12\" font-family=\"Arial\">${id}</text></svg>')}" alt="logo">`;
  }
  function qtyInput(id){ return `<input class="qty" id="qty-${id}" type="number" min="1" value="1">`; }
  function totalLabel(qty){ const t = (Number(qty||1)*VOTE_COST).toFixed(2); return `<span class="hint">Total: ${t} MON</span>` }

  let participants = [];

  async function refresh(){
    try{
      const count = Math.max(8, await getParticipantCount());
      const list = [];
      for(let i=1;i<=count;i++){ list.push(await getParticipant(i)); }
      participants = list;

      const state = await getTournamentState();
      // Build matches for up to 3 rounds (8->4, 4->2, 2->1)
      const r1 = [await getMatch(1,1),await getMatch(1,2),await getMatch(1,3),await getMatch(1,4)];
      const r2 = [await getMatch(2,1),await getMatch(2,2)];
      const r3 = [await getMatch(3,1)];
      renderBracket({state, r1, r2, r3});
    }catch(e){ console.error(e); }
  }

  function rowHTML(m, which){
    const pid = which===1? m.p1 : m.p2;
    const votes = which===1? m.v1 : m.v2;
    const oppVotes = which===1? m.v2 : m.v1;
    const isWin = m.finished && ((votes>=oppVotes) || m.winnerId===pid);
    const cls = m.finished? (isWin? 'row win':'row lose') : 'row';
    const name = (participants[pid-1]?.name) || (FALLBACK_NAMES[pid]||('P'+pid));
    return `
      <div class="${cls}">
        <div style="display:flex;align-items:center;gap:8px;min-width:0">
          ${imgTag(pid)}
          <div class="pname" title="ID ${pid}">${name}</div>
        </div>
        <div class="actions">
          <div class="badge" title="votes">${votes}</div>
          ${!m.finished ? `<div style="display:flex;align-items:center;gap:6px">
            ${qtyInput(`${m.round}-${m.match}-${pid}`)}
            <button class="btn primary" onclick="handleVote(${m.round},${m.match},${pid})">Vote</button>
          </div>` : ''}
        </div>
      </div>`;
  }

  function matchHTML(m){
    const left = Math.max(0, (m.endTime*1000) - Date.now());
    return `
      <div class="match card">
        <div class="split"><div class="pill">Round ${m.round} ‚Ä¢ Match ${m.match}</div><div class="timer">${left? ('‚è± '+fmtTime(left)) : (m.finished? 'Finished' : 'Pending')}</div></div>
        ${rowHTML(m,1)}
        <div class="connector"></div>
        ${rowHTML(m,2)}
      </div>`;
  }

  function colHTML(matches){
    return `<div class="col">${matches.map(matchHTML).join('')}</div>`
  }

  function renderBracket({state, r1, r2, r3}){
    const root = document.getElementById('bracket');
    root.innerHTML = ''+
      colHTML([r1[0], r1[1]].filter(Boolean))+
      colHTML([r2[0]].filter(Boolean))+
      colHTML([r3[0]].filter(Boolean))+
      colHTML([r2[1]].filter(Boolean))+
      colHTML([r1[2], r1[3]].filter(Boolean));
  }

  // ====== Button hooks ======
  window.handleVote = async (roundNum, matchNum, participantId) => {
    const el = document.getElementById(`qty-${roundNum}-${matchNum}-${participantId}`);
    const qty = Math.max(1, Number(el?.value||1));
    if(!confirm(`Confirm vote ${qty}x for participant ${participantId}? Total ${(qty*VOTE_COST).toFixed(2)} MON`)) return;
    try{ await vote(roundNum, matchNum, participantId, qty); }
    catch(e){ alert(e.message||e); }
  }

  document.getElementById('startBtn').onclick = async ()=>{ try{ await startTournament(); }catch(e){ alert(e.message||e) } };
  document.getElementById('forceBtn').onclick = async ()=>{ try{ await forceFinish(); }catch(e){ alert(e.message||e) } };
  document.getElementById('finishBtn').onclick = async ()=>{
    const r = Number(document.getElementById('roundInput').value||1);
    const m = Number(document.getElementById('matchInput').value||1);
    try{ await finishMatch(r,m); }catch(e){ alert(e.message||e) }
  };

  // Polling loop for real-time-ish updates
  refresh();
  setInterval(refresh, 10_000); // every 10s
  </script>
</body>
</html>
